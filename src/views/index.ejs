<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X (Twitter) Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1da1f2;
            margin-top: 0;
        }
        .message {
            padding: 12px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            color: #155724;
            margin-bottom: 20px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #1da1f2;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #1a91da;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
        }
        .char-count {
            text-align: right;
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }
        .char-count.warning {
            color: #d9534f;
        }
        .user-header {
            background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%);
            color: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .user-header h2 {
            margin: 0 0 8px 0;
            font-size: 24px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        .user-details {
            flex: 1;
        }
        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }
        .user-handle {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 0 0 4px 0;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin: 0;
            text-transform: uppercase;
        }
        .user-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .posts-section {
            margin-top: 40px;
        }
        .posts-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .posts-list {
            margin-top: 20px;
        }
        .post-item {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .post-content-wrapper {
            flex: 1;
        }
        .post-text {
            margin: 0 0 8px 0;
            color: #14171a;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .post-meta {
            font-size: 12px;
            color: #657786;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .post-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .post-status.draft {
            background: #e3f2fd;
            color: #1976d2;
        }
        .post-status.scheduled {
            background: #fff3e0;
            color: #f57c00;
        }
        .post-status.posted {
            background: #e8f5e9;
            color: #388e3c;
        }
        .post-status.failed {
            background: #ffebee;
            color: #d32f2f;
        }
        .post-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-success {
            background-color: #1da1f2;
        }
        .btn-success:hover:not(:disabled) {
            background-color: #1a91da;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .error-message {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 4px;
        }
        .loading {
            text-align: center;
            color: #657786;
            padding: 20px;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .checkbox-group input[type="datetime-local"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .schedule-input {
            margin-top: 12px;
            display: none;
        }
        .schedule-input.active {
            display: block;
        }
        .mode-selector {
            margin-bottom: 20px;
        }
        .mode-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .mode-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .mode-specific-fields {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        .mode-specific-fields.active {
            display: block;
        }
        .thread-item {
            margin-bottom: 12px;
        }
        .thread-item label {
            font-size: 12px;
            color: #657786;
        }
        .thread-item textarea {
            min-height: 80px;
        }
        .add-thread-btn {
            background: #657786;
            margin-top: 8px;
        }
        .add-thread-btn:hover {
            background: #4a5568;
        }
        .remove-thread-btn {
            background: #dc3545;
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 8px;
        }
        .remove-thread-btn:hover {
            background: #c82333;
        }
        .input-group {
            margin-bottom: 12px;
        }
        .input-group label {
            font-size: 12px;
            color: #657786;
            margin-bottom: 4px;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .mode-badge {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #14171a;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #657786;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #f7f9fa;
            color: #14171a;
        }
        .modal-body {
            padding: 24px;
        }
        .create-post-btn {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .create-post-btn:hover {
            background: #1a91da;
        }
        .create-post-btn:active {
            transform: scale(0.98);
        }
        .create-post-btn::before {
            content: '+';
            font-size: 20px;
            font-weight: 300;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>X (Twitter) Manager</h1>
        
        <% if (message) { %>
            <div class="message"><%= message %></div>
        <% } %>

        <div id="auth-section">
            <!-- Not authenticated - show connect button -->
            <p>Connect your X account to start posting tweets.</p>
            <a href="/auth/x" class="btn">Connect X Account</a>
        </div>

        <div id="tweet-section" style="display: none;">
            <!-- User Header with personalized info -->
            <div id="user-header" class="user-header" style="display: none;">
                <div class="user-loading">Loading your profile...</div>
            </div>

            <!-- Authenticated - show create post button -->
            <div style="margin-top: 24px; margin-bottom: 24px;">
                <button type="button" class="create-post-btn" onclick="openCreatePostModal()">Create New Post</button>
            </div>

            <!-- Create Post Modal -->
            <div id="createPostModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Create New Post</h2>
                        <button type="button" class="modal-close" onclick="closeCreatePostModal()" aria-label="Close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="createPostForm">
                    <!-- Mode Selector -->
                    <div class="mode-selector">
                        <label for="postMode">Post Type:</label>
                        <select id="postMode" name="mode" required>
                            <option value="single">Single Tweet</option>
                            <option value="thread">Thread</option>
                            <option value="reply">Reply</option>
                            <option value="quote">Quote Tweet</option>
                        </select>
                    </div>

                    <!-- Single Tweet / Reply / Quote Content -->
                    <div id="singleContent" class="form-group">
                        <label for="postText">Tweet Text:</label>
                        <textarea 
                            id="postText" 
                            name="text" 
                            maxlength="280" 
                            placeholder="What's happening?"
                        ></textarea>
                        <div class="char-count" id="charCount">0 / 280</div>
                    </div>

                    <!-- Thread Content -->
                    <div id="threadContent" class="mode-specific-fields">
                        <label style="margin-bottom: 12px; display: block; font-weight: 500;">Thread Tweets:</label>
                        <div id="threadItems">
                            <div class="thread-item">
                                <label>Tweet 1:</label>
                                <textarea class="thread-tweet" maxlength="280" placeholder="First tweet..."></textarea>
                                <div class="char-count">0 / 280</div>
                            </div>
                            <div class="thread-item">
                                <label>Tweet 2:</label>
                                <textarea class="thread-tweet" maxlength="280" placeholder="Second tweet..."></textarea>
                                <div class="char-count">0 / 280</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-small add-thread-btn" onclick="addThreadItem()">+ Add Tweet</button>
                    </div>

                    <!-- Reply Mode Fields -->
                    <div id="replyFields" class="mode-specific-fields">
                        <div class="input-group">
                            <label for="replyToId">Reply to Tweet ID:</label>
                            <input 
                                type="text" 
                                id="replyToId" 
                                name="replyToId" 
                                placeholder="1234567890"
                            >
                            <small style="color: #657786; font-size: 11px;">Enter the X tweet ID you're replying to</small>
                        </div>
                    </div>

                    <!-- Quote Mode Fields -->
                    <div id="quoteFields" class="mode-specific-fields">
                        <div class="input-group">
                            <label for="quoteTweetId">Quote Tweet ID:</label>
                            <input 
                                type="text" 
                                id="quoteTweetId" 
                                name="quoteTweetId" 
                                placeholder="1234567890"
                            >
                            <small style="color: #657786; font-size: 11px;">Enter the X tweet ID you're quoting</small>
                        </div>
                    </div>

                    <!-- Media (placeholder for future implementation) -->
                    <div class="form-group" style="margin-top: 16px;">
                        <label>Media (Coming Soon)</label>
                        <input type="file" disabled style="opacity: 0.5;">
                        <small style="color: #657786; font-size: 11px;">Media upload will be available soon</small>
                    </div>
                    
                    <!-- Scheduling -->
                    <div class="checkbox-group" style="margin-top: 16px;">
                        <input type="checkbox" id="schedulePost" name="schedule">
                        <label for="schedulePost" style="margin: 0; font-weight: normal;">Schedule for later</label>
                    </div>
                    
                    <div class="schedule-input" id="scheduleInput">
                        <label for="scheduledAt" style="margin-top: 12px; display: block;">Schedule Date & Time:</label>
                        <input 
                            type="datetime-local" 
                            id="scheduledAt" 
                            name="scheduledAt"
                            min=""
                        >
                        
                        <!-- Repeat Options -->
                        <div style="margin-top: 16px;">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableRepeat" name="enableRepeat">
                                <label for="enableRepeat" style="margin: 0; font-weight: normal;">Repeat this post</label>
                            </div>
                            
                            <div id="repeatOptions" style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px; display: none;">
                                <div style="margin-bottom: 12px;">
                                    <label for="repeatFrequency" style="display: block; margin-bottom: 4px; font-size: 12px; color: #657786;">Repeat Frequency:</label>
                                    <select id="repeatFrequency" name="repeatFrequency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #657786;">End Repeat (Optional):</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="radio" id="repeatEndDate" name="repeatEnd" value="date" checked>
                                        <label for="repeatEndDate" style="margin: 0; font-weight: normal; font-size: 12px;">End Date:</label>
                                        <input 
                                            type="datetime-local" 
                                            id="repeatUntil" 
                                            name="repeatUntil"
                                            style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                        >
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                        <input type="radio" id="repeatEndCount" name="repeatEnd" value="count">
                                        <label for="repeatEndCount" style="margin: 0; font-weight: normal; font-size: 12px;">After</label>
                                        <input 
                                            type="number" 
                                            id="repeatCount" 
                                            name="repeatCount"
                                            min="1"
                                            max="365"
                                            placeholder="10"
                                            style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                        >
                                        <label style="margin: 0; font-weight: normal; font-size: 12px;">times</label>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                        <input type="radio" id="repeatEndNever" name="repeatEnd" value="never">
                                        <label for="repeatEndNever" style="margin: 0; font-weight: normal; font-size: 12px;">Never (repeat indefinitely)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                            <div class="form-actions" style="margin-top: 16px; display: flex; align-items: center; gap: 12px;">
                                <button type="submit" class="btn" id="createPostBtn">Create Draft</button>
                                <button type="button" class="btn" style="background: #657786;" onclick="closeCreatePostModal()">Cancel</button>
                                <span id="createPostStatus" style="color: #666; font-size: 14px;"></span>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Posts List -->
            <div class="posts-section">
                <h2>Your Posts</h2>
                <div id="posts-list" class="loading">Loading posts...</div>
            </div>
        </div>
    </div>

    <script>
        // Token storage key
        const TOKEN_KEY = 'x_access_token';

        // Check if token is in URL (from OAuth callback)
        <% if (token) { %>
        const urlToken = '<%= token %>';
        if (urlToken) {
            // Store token in localStorage
            localStorage.setItem(TOKEN_KEY, urlToken);
            // Remove token from URL for security
            const url = new URL(window.location);
            url.searchParams.delete('token');
            window.history.replaceState({}, '', url);
        }
        <% } %>

        // Modal functions
        function openCreatePostModal() {
            const modal = document.getElementById('createPostModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        function closeCreatePostModal() {
            const modal = document.getElementById('createPostModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('createPostModal');
            if (event.target === modal) {
                closeCreatePostModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCreatePostModal();
            }
        });

        // Handle token failure - clear token and show reconnect message
        function handleTokenFailure() {
            // Clear invalid token
            localStorage.removeItem(TOKEN_KEY);
            
            // Hide authenticated sections
            const tweetSection = document.getElementById('tweet-section');
            const authSection = document.getElementById('auth-section');
            
            if (tweetSection) tweetSection.style.display = 'none';
            if (authSection) {
                authSection.innerHTML = `
                    <div style="padding: 16px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 16px;">
                        <p style="margin: 0 0 12px 0; color: #856404; font-weight: 500;">
                            ‚ö†Ô∏è Your session has expired or the access token is invalid.
                        </p>
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            Please reconnect your X account to continue.
                        </p>
                    </div>
                    <a href="/auth/x" class="btn">Reconnect X Account</a>
                `;
                authSection.style.display = 'block';
            }
        }

        // Load user data from API
        async function loadUserData(accessToken) {
            const userHeader = document.getElementById('user-header');
            if (!userHeader) return;

            try {
                const response = await fetch(`/api/user?accessToken=${encodeURIComponent(accessToken)}`);
                
                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(response)) {
                    return;
                }
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load user data');
                }

                const user = data.user;
                
                // Get first letter of name for avatar
                const avatarLetter = user.name ? user.name.charAt(0).toUpperCase() : user.x_account.username.charAt(0).toUpperCase();
                
                // Format join date
                const joinDate = new Date(user.created_at);
                const formattedDate = joinDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Display user info
                userHeader.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${avatarLetter}</div>
                        <div class="user-details">
                            <h2 class="user-name">${escapeHtml(user.name || user.x_account.username)}</h2>
                            <p class="user-handle">@${escapeHtml(user.x_account.username)}</p>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${user.stats.total}</div>
                            <div class="stat-label">Total Posts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${user.stats.posted}</div>
                            <div class="stat-label">Posted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${user.stats.draft}</div>
                            <div class="stat-label">Drafts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${user.stats.scheduled}</div>
                            <div class="stat-label">Scheduled</div>
                        </div>
                    </div>
                    <p style="margin: 16px 0 0 0; font-size: 12px; opacity: 0.8;">Member since ${formattedDate}</p>
                `;
                userHeader.style.display = 'block';
            } catch (error) {
                console.error('Error loading user data:', error);
                // If it's a network error, don't clear token (might be temporary)
                if (error.message.includes('Failed to fetch')) {
                    userHeader.innerHTML = '<p style="color: rgba(255,255,255,0.9);">Unable to load profile data. Please check your connection.</p>';
                    userHeader.style.display = 'block';
                } else {
                    // For other errors, check if it might be auth-related
                    handleTokenFailure();
                }
            }
        }

        // Load posts from API
        async function loadPosts(accessToken) {
            const postsList = document.getElementById('posts-list');
            if (!postsList) return;

            try {
                const response = await fetch(`/api/posts?accessToken=${encodeURIComponent(accessToken)}`);
                
                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(response)) {
                    return;
                }
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load posts');
                }

                if (data.posts.length === 0) {
                    postsList.innerHTML = '<p style="color: #657786;">No posts yet. Create your first post above!</p>';
                    return;
                }

                postsList.innerHTML = data.posts.map(post => {
                    // Determine display content based on mode
                    let displayContent = '';
                    if (post.mode === 'thread' && post.thread && Array.isArray(post.thread)) {
                        displayContent = post.thread.map((tweet, idx) => 
                            `<div style="margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                                <strong>Tweet ${idx + 1}:</strong> ${escapeHtml(tweet)}
                            </div>`
                        ).join('');
                    } else {
                        displayContent = escapeHtml(post.content || '');
                    }

                    // Mode badge
                    const modeLabels = {
                        'single': 'Single',
                        'thread': 'Thread',
                        'reply': 'Reply',
                        'quote': 'Quote'
                    };

                    return `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-content-wrapper">
                            <p class="post-text">${displayContent}</p>
                            <div class="post-meta">
                                <span class="post-status ${post.status}">${post.status}</span>
                                <span class="mode-badge">${modeLabels[post.mode] || post.mode}</span>
                                ${post.reply_to_id ? `<span>Reply to: ${post.reply_to_id}</span>` : ''}
                                ${post.quote_tweet_id ? `<span>Quote: ${post.quote_tweet_id}</span>` : ''}
                                ${post.posted_at ? `<span>Posted: ${formatDate(post.posted_at)}</span>` : ''}
                                ${post.scheduled_at ? `<span>Scheduled: ${formatDate(post.scheduled_at)}</span>` : ''}
                                ${post.repeat_enabled ? `<span style="color: #1da1f2;">üîÑ Repeats ${post.repeat_frequency}${post.repeat_until ? ` until ${formatDate(post.repeat_until)}` : ''}${post.repeat_count ? ` (${post.repeat_occurrence || 1}/${post.repeat_count})` : ''}</span>` : ''}
                                ${post.created_at ? `<span>Created: ${formatDate(post.created_at)}</span>` : ''}
                                ${(post.platform_post_id || post.x_tweet_id) ? `<span><a href="https://twitter.com/i/web/status/${post.platform_post_id || post.x_tweet_id}" target="_blank" style="color: #1da1f2;">View on X</a></span>` : ''}
                                ${(post.platform_thread_ids || post.x_thread_ids) && (post.platform_thread_ids || post.x_thread_ids).length > 0 ? `<span><a href="https://twitter.com/i/web/status/${(post.platform_thread_ids || post.x_thread_ids)[0]}" target="_blank" style="color: #1da1f2;">View Thread</a></span>` : ''}
                                ${post.error_message ? `<span class="error-message">Error: ${escapeHtml(post.error_message.substring(0, 100))}</span>` : ''}
                            </div>
                        </div>
                        <div class="post-actions">
                            ${post.status === 'draft' ? `
                                <button class="btn btn-small btn-success" onclick="postToX(${post.id})" id="post-btn-${post.id}">
                                    Post
                                </button>
                            ` : post.status === 'scheduled' ? `
                                <button class="btn btn-small btn-success" onclick="postToX(${post.id})" id="post-btn-${post.id}">
                                    Post Now
                                </button>
                                <button class="btn btn-small" style="background: #657786; margin-left: 8px;" onclick="reschedulePost(${post.id})" id="reschedule-btn-${post.id}">
                                    Reschedule
                                </button>
                            ` : post.status === 'posted' ? `
                                <button class="btn btn-small btn-success" onclick="repostToX(${post.id})" id="repost-btn-${post.id}">
                                    Repost
                                </button>
                            ` : post.status === 'failed' ? `
                                <button class="btn btn-small btn-success" onclick="postToX(${post.id})" id="post-btn-${post.id}">
                                    Retry
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Error loading posts:', error);
                postsList.innerHTML = `<p style="color: #d32f2f;">Error loading posts: ${error.message}</p>`;
            }
        }

        // Post a specific post to X
        async function postToX(postId) {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                handleTokenFailure();
                return;
            }

            const button = document.getElementById(`post-btn-${postId}`);
            const originalText = button ? button.textContent : 'Post';
            if (button) {
                button.disabled = true;
                button.textContent = 'Posting...';
            }

            try {
                const response = await fetch(`/api/posts/${postId}/post`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ accessToken: token })
                });

                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(response)) {
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                    return;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to post');
                }

                // Reload posts and user data
                loadPosts(token);
                loadUserData(token);
            } catch (error) {
                console.error('Error posting:', error);
                
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // Repost a previously posted item (creates new post with same content)
        async function repostToX(postId) {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                handleTokenFailure();
                return;
            }

            const button = document.getElementById(`repost-btn-${postId}`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Reposting...';
            }

            try {
                // Get the post details first
                const getResponse = await fetch(`/api/posts?accessToken=${encodeURIComponent(token)}`);
                
                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(getResponse)) {
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Repost';
                    }
                    return;
                }
                
                const getData = await getResponse.json();
                
                if (!getResponse.ok) {
                    throw new Error(getData.error || 'Failed to fetch post');
                }

                const post = getData.posts.find(p => p.id === postId);
                if (!post) {
                    throw new Error('Post not found');
                }

                // Create new post data from existing post
                const postData = {
                    mode: post.mode || 'single',
                    accessToken: token
                };

                if (post.mode === 'thread' && post.thread) {
                    postData.thread = post.thread;
                } else {
                    postData.text = post.content;
                }

                if (post.reply_to_id) {
                    postData.replyToId = post.reply_to_id;
                }
                if (post.quote_tweet_id) {
                    postData.quoteTweetId = post.quote_tweet_id;
                }
                if (post.media) {
                    postData.media = post.media;
                }

                // Create new draft post
                const createResponse = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(createResponse)) {
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Repost';
                    }
                    return;
                }

                const createData = await createResponse.json();

                if (!createResponse.ok) {
                    throw new Error(createData.error || 'Failed to create repost');
                }

                // Immediately post the new draft
                const newPostId = createData.post.id;
                await postToX(newPostId);

            } catch (error) {
                console.error('Error reposting:', error);
                
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Repost';
                }
            }
        }

        // Reschedule a scheduled post
        async function reschedulePost(postId) {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                handleTokenFailure();
                return;
            }

            // Get current scheduled time
            const getResponse = await fetch(`/api/posts?accessToken=${encodeURIComponent(token)}`);
            
            // Check for unauthorized errors (including 500 with unauthorized message)
            if (await checkForUnauthorizedError(getResponse)) {
                return;
            }
            
            const getData = await getResponse.json();
            
            if (!getResponse.ok) {
                console.error('Failed to fetch post details');
                return;
            }

            const post = getData.posts.find(p => p.id === postId);
            if (!post) {
                console.error('Post not found');
                return;
            }

            // Open reschedule modal
            openRescheduleModal(postId, post.scheduled_at);
        }

        // Open reschedule modal
        function openRescheduleModal(postId, currentScheduledAt) {
            // Create or get reschedule modal
            let modal = document.getElementById('rescheduleModal');
            if (!modal) {
                // Create modal
                modal = document.createElement('div');
                modal.id = 'rescheduleModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2>Reschedule Post</h2>
                            <button type="button" class="modal-close" onclick="closeRescheduleModal()" aria-label="Close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <label for="rescheduleDateTime" style="display: block; margin-bottom: 8px;">New Scheduled Date & Time:</label>
                            <input 
                                type="datetime-local" 
                                id="rescheduleDateTime" 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                            >
                            <div class="form-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn" style="background: #657786;" onclick="closeRescheduleModal()">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="confirmReschedule(${postId})">Reschedule</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Set current date/time
            const currentDate = currentScheduledAt ? new Date(currentScheduledAt) : new Date();
            currentDate.setMinutes(currentDate.getMinutes() + 1);
            const dateInput = document.getElementById('rescheduleDateTime');
            if (dateInput) {
                dateInput.value = currentDate.toISOString().slice(0, 16);
                dateInput.min = new Date().toISOString().slice(0, 16);
                dateInput.dataset.postId = postId;
            }

            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeRescheduleModal() {
            const modal = document.getElementById('rescheduleModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        async function confirmReschedule(postId) {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                handleTokenFailure();
                return;
            }

            const dateInput = document.getElementById('rescheduleDateTime');
            if (!dateInput || !dateInput.value) {
                return;
            }

            const newDate = new Date(dateInput.value);
            if (isNaN(newDate.getTime()) || newDate <= new Date()) {
                return;
            }

            const button = document.querySelector(`#reschedule-btn-${postId}`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Rescheduling...';
            }

            try {
                const response = await fetch(`/api/posts/${postId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accessToken: token,
                        scheduledAt: newDate.toISOString()
                    })
                });

                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(response)) {
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Reschedule';
                    }
                    return;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reschedule');
                }

                closeRescheduleModal();
                loadPosts(token);
            } catch (error) {
                console.error('Error rescheduling:', error);
                
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Reschedule';
                }
            }
        }

        // Close reschedule modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('rescheduleModal');
            if (event.target === modal) {
                closeRescheduleModal();
            }
        });

        // Create a new draft post
        async function createPost(postData) {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                handleTokenFailure();
                return false;
            }

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                // Check for unauthorized errors (including 500 with unauthorized message)
                if (await checkForUnauthorizedError(response)) {
                    return false;
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create post');
                }

                return true;
            } catch (error) {
                console.error('Error creating post:', error);
                throw error;
            }
        }

        // Check authentication status from localStorage
        function checkAuth() {
            const token = localStorage.getItem(TOKEN_KEY);
            const authSection = document.getElementById('auth-section');
            const tweetSection = document.getElementById('tweet-section');

            if (token) {
                // User is authenticated - show tweet form
                authSection.style.display = 'none';
                tweetSection.style.display = 'block';
                // Load user data and posts
                loadUserData(token);
                loadPosts(token);
            } else {
                // User not authenticated - show connect button
                authSection.style.display = 'block';
                tweetSection.style.display = 'none';
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to check for unauthorized errors (500 or other status codes)
        async function checkForUnauthorizedError(response) {
            // Check for 500 status code
            if (response.status === 500) {
                try {
                    const data = await response.clone().json();
                    const errorMessage = (data.error || data.message || JSON.stringify(data)).toLowerCase();
                    
                    if (errorMessage.includes('unauthorized') || 
                        errorMessage.includes('invalid token') || 
                        errorMessage.includes('expired token') ||
                        errorMessage.includes('token expired') ||
                        errorMessage.includes('authentication failed')) {
                        console.warn('Unauthorized error detected in 500 response:', errorMessage);
                        handleTokenFailure();
                        return true;
                    }
                } catch (e) {
                    // If we can't parse JSON, try to get text
                    try {
                        const text = await response.clone().text();
                        const errorMessage = text.toLowerCase();
                        
                        if (errorMessage.includes('unauthorized') || 
                            errorMessage.includes('invalid token') || 
                            errorMessage.includes('expired token') ||
                            errorMessage.includes('token expired') ||
                            errorMessage.includes('authentication failed')) {
                            console.warn('Unauthorized error detected in 500 response text:', errorMessage);
                            handleTokenFailure();
                            return true;
                        }
                    } catch (e2) {
                        // If we can't read the response, just log it
                        console.error('Error reading 500 response:', e2);
                    }
                }
            }
            
            // Also check for 401 (already handled, but be consistent)
            if (response.status === 401) {
                handleTokenFailure();
                return true;
            }
            
            return false;
        }

        // Handle mode switching
        const postModeSelect = document.getElementById('postMode');
        const singleContent = document.getElementById('singleContent');
        const threadContent = document.getElementById('threadContent');
        const replyFields = document.getElementById('replyFields');
        const quoteFields = document.getElementById('quoteFields');

        function updateModeFields() {
            const mode = postModeSelect.value;
            
            // Hide all mode-specific fields
            singleContent.style.display = 'none';
            threadContent.classList.remove('active');
            replyFields.classList.remove('active');
            quoteFields.classList.remove('active');
            
            // Show relevant fields based on mode
            if (mode === 'single') {
                singleContent.style.display = 'block';
                document.getElementById('postText').required = true;
            } else if (mode === 'thread') {
                singleContent.style.display = 'none';
                threadContent.classList.add('active');
                document.getElementById('postText').required = false;
            } else if (mode === 'reply') {
                singleContent.style.display = 'block';
                replyFields.classList.add('active');
                document.getElementById('postText').required = true;
                document.getElementById('replyToId').required = true;
            } else if (mode === 'quote') {
                singleContent.style.display = 'block';
                quoteFields.classList.add('active');
                document.getElementById('postText').required = true;
                document.getElementById('quoteTweetId').required = true;
            }
        }

        if (postModeSelect) {
            postModeSelect.addEventListener('change', updateModeFields);
            updateModeFields(); // Initialize
        }

        // Thread management
        function addThreadItem() {
            const threadItems = document.getElementById('threadItems');
            const count = threadItems.children.length + 1;
            const newItem = document.createElement('div');
            newItem.className = 'thread-item';
            newItem.innerHTML = `
                <label>Tweet ${count}:</label>
                <textarea class="thread-tweet" maxlength="280" placeholder="Tweet ${count}..."></textarea>
                <div class="char-count">0 / 280</div>
                <button type="button" class="btn btn-small remove-thread-btn" onclick="removeThreadItem(this)">Remove</button>
            `;
            threadItems.appendChild(newItem);
            
            // Add character counter
            const textarea = newItem.querySelector('textarea');
            const charCount = newItem.querySelector('.char-count');
            textarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = `${length} / 280`;
                if (length > 260) {
                    charCount.classList.add('warning');
                } else {
                    charCount.classList.remove('warning');
                }
            });
        }

        function removeThreadItem(button) {
            const threadItems = document.getElementById('threadItems');
            if (threadItems.children.length > 2) {
                button.closest('.thread-item').remove();
                // Renumber items
                Array.from(threadItems.children).forEach((item, index) => {
                    item.querySelector('label').textContent = `Tweet ${index + 1}:`;
                });
            } else {
                console.warn('Thread must have at least 2 tweets');
            }
        }

        // Make removeThreadItem available globally
        window.removeThreadItem = removeThreadItem;
        window.addThreadItem = addThreadItem;

        // Initialize form handlers (runs after DOM is ready)
        function initializeFormHandlers() {
            const createPostForm = document.getElementById('createPostForm');
            const scheduleCheckbox = document.getElementById('schedulePost');
            const scheduleInput = document.getElementById('scheduleInput');
            const scheduledAtInput = document.getElementById('scheduledAt');
            const enableRepeatCheckbox = document.getElementById('enableRepeat');
            const repeatOptions = document.getElementById('repeatOptions');
            const createPostBtn = document.getElementById('createPostBtn');
            const createPostStatus = document.getElementById('createPostStatus');

            if (!createPostForm) return;

            // Toggle schedule input visibility
            if (scheduleCheckbox && scheduleInput) {
                scheduleCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        scheduleInput.classList.add('active');
                        // Set minimum date to now
                        const now = new Date();
                        now.setMinutes(now.getMinutes() + 1); // At least 1 minute in future
                        if (scheduledAtInput) {
                            scheduledAtInput.min = now.toISOString().slice(0, 16);
                        }
                    } else {
                        scheduleInput.classList.remove('active');
                        // Hide repeat options if schedule is unchecked
                        if (enableRepeatCheckbox) {
                            enableRepeatCheckbox.checked = false;
                        }
                        if (repeatOptions) {
                            repeatOptions.style.display = 'none';
                        }
                    }
                });
            }

            // Toggle repeat options visibility
            if (enableRepeatCheckbox && repeatOptions) {
                enableRepeatCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        repeatOptions.style.display = 'block';
                        // Ensure schedule is also checked
                        if (scheduleCheckbox && !scheduleCheckbox.checked) {
                            scheduleCheckbox.checked = true;
                            if (scheduleInput) {
                                scheduleInput.classList.add('active');
                            }
                            const now = new Date();
                            now.setMinutes(now.getMinutes() + 1);
                            if (scheduledAtInput) {
                                scheduledAtInput.min = now.toISOString().slice(0, 16);
                            }
                        }
                    } else {
                        repeatOptions.style.display = 'none';
                    }
                });
            }

            // Handle form submission
            createPostForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const token = localStorage.getItem(TOKEN_KEY);
                if (!token) {
                    handleTokenFailure();
                    return;
                }

                const mode = postModeSelect.value;
                const scheduleCheckboxEl = document.getElementById('schedulePost');
                const scheduledAtInputEl = document.getElementById('scheduledAt');
                const enableRepeatCheckboxEl = document.getElementById('enableRepeat');
                const isScheduled = scheduleCheckboxEl && scheduleCheckboxEl.checked;
                const scheduledAt = isScheduled && scheduledAtInputEl ? scheduledAtInputEl.value : null;
                
                // Get repeat settings
                const repeatEnabled = enableRepeatCheckboxEl && enableRepeatCheckboxEl.checked;
                let repeatSettings = null;
                if (repeatEnabled && isScheduled) {
                    const frequency = document.getElementById('repeatFrequency')?.value || 'daily';
                    const repeatEnd = document.querySelector('input[name="repeatEnd"]:checked')?.value || 'never';
                    
                    repeatSettings = {
                        frequency: frequency,
                        until: null,
                        count: null
                    };
                    
                    if (repeatEnd === 'date') {
                        const untilInput = document.getElementById('repeatUntil');
                        if (untilInput && untilInput.value) {
                            repeatSettings.until = new Date(untilInput.value).toISOString();
                        }
                    } else if (repeatEnd === 'count') {
                        const countInput = document.getElementById('repeatCount');
                        if (countInput && countInput.value) {
                            repeatSettings.count = parseInt(countInput.value);
                        }
                    }
                    // else 'never' - no end date or count
                }

                // Collect data based on mode
                let postData = {
                    mode: mode,
                    accessToken: token
                };

                if (mode === 'single') {
                    const text = document.getElementById('postText').value;
                    if (!text.trim()) {
                        return;
                    }
                    postData.text = text;
                } else if (mode === 'thread') {
                    const threadItems = document.querySelectorAll('.thread-tweet');
                    const thread = Array.from(threadItems).map(item => item.value.trim()).filter(v => v);
                    if (thread.length < 2) {
                        return;
                    }
                    postData.thread = thread;
                } else if (mode === 'reply') {
                    const text = document.getElementById('postText').value;
                    const replyToId = document.getElementById('replyToId').value.trim();
                    if (!text.trim() || !replyToId) {
                        return;
                    }
                    postData.text = text;
                    postData.replyToId = replyToId;
                } else if (mode === 'quote') {
                    const text = document.getElementById('postText').value;
                    const quoteTweetId = document.getElementById('quoteTweetId').value.trim();
                    if (!text.trim() || !quoteTweetId) {
                        return;
                    }
                    postData.text = text;
                    postData.quoteTweetId = quoteTweetId;
                }

                if (scheduledAt) {
                    postData.scheduledAt = new Date(scheduledAt).toISOString();
                }
                
                if (repeatSettings) {
                    postData.repeat = repeatSettings;
                }

                // Disable button and show status
                if (createPostBtn) {
                    createPostBtn.disabled = true;
                    createPostBtn.textContent = 'Creating...';
                }
                if (createPostStatus) {
                    createPostStatus.textContent = '';
                }

                try {
                    await createPost(postData);
                    
                    // Success - clear form and reload posts
                    createPostForm.reset();
                    const scheduleInputEl = document.getElementById('scheduleInput');
                    const enableRepeatCheckboxEl = document.getElementById('enableRepeat');
                    const repeatOptionsEl = document.getElementById('repeatOptions');
                    if (scheduleInputEl) {
                        scheduleInputEl.classList.remove('active');
                    }
                    if (enableRepeatCheckboxEl) {
                        enableRepeatCheckboxEl.checked = false;
                    }
                    if (repeatOptionsEl) {
                        repeatOptionsEl.style.display = 'none';
                    }
                    updateModeFields(); // Reset to default mode
                    document.getElementById('charCount').textContent = '0 / 280';
                    
                    // Reset thread to 2 items
                    const threadItems = document.getElementById('threadItems');
                    if (threadItems) {
                        threadItems.innerHTML = `
                            <div class="thread-item">
                                <label>Tweet 1:</label>
                                <textarea class="thread-tweet" maxlength="280" placeholder="First tweet..."></textarea>
                                <div class="char-count">0 / 280</div>
                            </div>
                            <div class="thread-item">
                                <label>Tweet 2:</label>
                                <textarea class="thread-tweet" maxlength="280" placeholder="Second tweet..."></textarea>
                                <div class="char-count">0 / 280</div>
                            </div>
                        `;
                    }
                    
                    if (createPostStatus) {
                        createPostStatus.textContent = isScheduled ? '‚úì Post scheduled!' : '‚úì Draft created!';
                        createPostStatus.style.color = '#388e3c';
                    }
                    
                    // Reload posts and user data
                    loadPosts(token);
                    loadUserData(token);
                    
                    // Close modal and reset button after 2 seconds
                    setTimeout(() => {
                        closeCreatePostModal();
                        if (createPostBtn) {
                            createPostBtn.disabled = false;
                            createPostBtn.textContent = 'Create Draft';
                        }
                        if (createPostStatus) {
                            createPostStatus.textContent = '';
                        }
                    }, 2000);
                } catch (error) {
                    console.error('Error creating post:', error);
                    
                    if (createPostBtn) {
                        createPostBtn.disabled = false;
                        createPostBtn.textContent = 'Create Draft';
                    }
                    if (createPostStatus) {
                        createPostStatus.textContent = '';
                    }
                }
            });
        }

        // Initialize form handlers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFormHandlers);
        } else {
            initializeFormHandlers();
        }

        // Initialize auth check on page load
        checkAuth();

        // Character counter for post textarea
        const postTextarea = document.getElementById('postText');
        const charCount = document.getElementById('charCount');
        
        if (postTextarea && charCount) {
            postTextarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = `${length} / 280`;
                if (length > 260) {
                    charCount.classList.add('warning');
                } else {
                    charCount.classList.remove('warning');
                }
            });
        }

        // Character counters for thread items
        document.addEventListener('DOMContentLoaded', function() {
            const threadTextareas = document.querySelectorAll('.thread-tweet');
            threadTextareas.forEach(textarea => {
                const charCount = textarea.nextElementSibling;
                if (charCount && charCount.classList.contains('char-count')) {
                    textarea.addEventListener('input', function() {
                        const length = this.value.length;
                        charCount.textContent = `${length} / 280`;
                        if (length > 260) {
                            charCount.classList.add('warning');
                        } else {
                            charCount.classList.remove('warning');
                        }
                    });
                }
            });
        });

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString();
        }
    </script>
</body>
</html>
